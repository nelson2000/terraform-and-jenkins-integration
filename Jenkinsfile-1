pipeline{
    agent any
     parameters {
                choice choices: ['apply', 'destroy'], description: 'You can apply and the destroy resources, choose', name: 'action'
                }
    
    stages{
        stage("terraform init"){
            steps{
                echo "Initializing terraform"
                sh "terraform init"
            }
           
        }
        
         stage("terraform validate"){
          steps{
                echo "terraform validate"
                sh "terraform validate"
            }
           
        }
        
          stage("terraform format"){
          steps{
                echo "terraform format all config tf files"
                sh "terraform fmt"
            }
           
        }

        stage("terraform action"){
           
            steps{
            
                withCredentials([aws(accessKeyVariable:'AWS_ACCESS_KEY_ID', credentialsid: 'aws_cred', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                                echo "terraform carry out action ---> ${action}"
                                sh "terraform ${action} --auto-approve"
                }
            }
           
        }

    }
  
}
